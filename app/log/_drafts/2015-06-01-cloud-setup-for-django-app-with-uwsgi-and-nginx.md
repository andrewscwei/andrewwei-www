---
published: true
title: Cloud Setup for Django App with uWSGI and Nginx
tags: 
  - systems
---

This log demonstrates how to set up a Django app on a cloud VM instance and serve it using uWSGI and Nginx from **scratch**. Note the following assumptions:

1.	The app will be served on a Linux system.
2.	The app is living in an existing [Git](https://git-scm.com) repo.
3. 	The database which the app uses will be set up in the same VM instance as the app.
4.	The app is generated by [generator-vars-django](https://github.com/VARIANTE/generator-vars-django), which uses [Gulp](http://gulpjs.com) as its asset pipeline, hence depends on [Node.js](https://nodejs.org).
5.	The app will be stored in `/srv`.

Let's begin.

## Installing Dependencies

1.	Update APT packages, no explanations needed.
    ```
    $ sudo apt-get update
    ```

2.	Install [Git](https://git-scm.com) to pull down the app's source code.
    ```
    $ sudo apt-get install git-core
    ```
   
3.	Install [Upstart](http://upstart.ubuntu.com) if the system is still using [SysVinit](https://wiki.archlinux.org/index.php/SysVinit). This will make writing startup scripts much easier later on.
    ```
    $ sudo apt-get install upstart
    ```
	When prompted, enter 'Yes, do as I say!'.

4.	Install `nvm` so you have the freedom to juggle between different `npm` versions. Install it globally to save yourself from the trouble of managing global node packages later on. This allows you to run `nvm` with `sudo`. Follow this [guide](https://github.com/xtuple/nvm) or simply run:
    ```
    $ sudo wget -qO- https://raw.githubusercontent.com/xtuple/nvm/master/install.sh | sudo bash
    ```

5. 	Install `node` via `nvm`. Pick the version of your choice.
```
$ sudo nvm ls-remote
$ sudo nvm install x.xx.x
```

6.	Install `gulp` globally to build the app (assuming you have [Gulp](http://gulpjs.com) setup, which comes with [generator-vars-django](https://github.com/VARIANTE/generator-vars-django):
```
sudo npm install -g gulp
```

7. 	Install `python` and `pip` as needed by any Django app.
```
$ sudo apt-get install python-pip python-virtualenv python-dev build-essential
```

8. 	Install database of your choice. Here are a couple examples:
	##### MySQL
    	```
        $ sudo apt-get install mysql-server
		$ sudo apt-get install python-mysqldb
		```
    ##### PostgreSQL
    	```
        $ sudo apt-get install libpq-dev python-dev python-psycopg2
		$ sudo apt-get install postgresql postgresql-contrib
        ```
       
9.	Install uWSGI. Do it through `pip` instead of `apt-get` to get the most updated version.
	```
    $ sudo pip install uwsgi
    ```
    
10.	Install Nginx:
	```
    $ sudo apt-get install nginx
    ```

## Database Configuration

You will need to set up your database before you can run a Django app (if you are not using SQLite). Basically you need to create a new database with a new owner and password. Here are a couple examples for MySQL and PostgreSQL:

##### MySQL

```
$ mysql_secure_installation
$ mysql --user=root --password={password}
$ mysql> create database {db_name};
$ mysql> quit;
```

##### PostgreSQL

```
$ sudo su postgres
$ createuser -P
$ createdb --owner username dbname
$ exit
```

## Python Virtual Environment Setup

Python packages required by the app will be installed into the virtual environment. Create one in `/srv`:

```
$ cd /srv
$ sudo virtualenv .
```

Before sourcing it, add any environment variables your app needs to ```bin/activate```, such as the Django secret key. Assuming the app is generated by [generator-vars-django](https://github.com/VARIANTE/generator-vars-django), all the database credentials need to go in there as well.

```
$ sudo nano /srv/bin/activate
```

Add the following to the end of the file (replace {} with your own varaibles):

```
export DJANGO_SECRET_KEY="{django_secret_key}"
export DJANGO_DB_NAME="{db_name}"
export DJANGO_DB_USER="{db_user}"
export DJANGO_DB_PASS="{db_password}"
export DJANGO_DB_HOST="localhost"
export DJANGO_DB_PORT="{db_port}"
```

Finally, source it:

```
$ source /srv/bin/activate
```

## App Setup

1.	Clone the source code to `/srv`. It is best to have the source code inside a folder like `example.com`. This should already be taken care of if the app is generated by [generator-vars-django](https://github.com/VARIANTE/generator-vars-django).

2. 	Install Python dependencies. Remember to activate the virtual environment first.
	```
    $ sudo pip install -r requirements.txt
    ```
    
    Double check that the packages were installed to the virtual environment:
    ```
    $ which django-admin
    ```
    
    If it's not, you should redo this step. It might be because the command was executed using `sudo`. In which case you will either need to give your account write permission for `/srv` so you can run `pip install` without `sudo`, or you can simply login as `root` by doing:
    ```
    $ sudo su -
    ```

3.	Install Node modules.
	```
    $ sudo npm install
	```

4.	Do the initial Django migration:
	```
    $ gulp migrate
    ```
    
5.	Build it.
	```
    $ gulp
    ```
	You should now have the app built and deployed to the `build` directory.
    
## Serving the App





